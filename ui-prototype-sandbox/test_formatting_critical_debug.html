<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRITICAL: Formatting Debug Test - Executive Review</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .critical-banner { 
            background: #f44336; 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        .test-section { 
            border: 2px solid #333; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .test-result { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            background: #f9f9f9;
        }
        .before-after { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin: 15px 0;
        }
        .before { 
            background: #ffe8e8; 
            padding: 15px; 
            border: 2px solid #ff0000;
            border-radius: 8px;
        }
        .after { 
            background: #e8f5e8; 
            padding: 15px; 
            border: 2px solid #00aa00;
            border-radius: 8px;
        }
        .mock-chat {
            border: 2px solid #333;
            padding: 15px;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
        }
        .mock-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            margin: 10px 0;
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="critical-banner">
        üö® CRITICAL FORMATTING DEBUG - EXECUTIVE REVIEW REQUIRED üö®
    </div>
    
    <h1>Formatting Issues Investigation - Worker #4</h1>
    
    <p><strong>Issue:</strong> User confirmed AI response formatting completely broken despite previous completion report.</p>
    <p><strong>Status:</strong> Previous completion report was INCORRECT - investigating root cause</p>
    
    <button onclick="runCriticalDebug()" style="padding: 15px 30px; font-size: 18px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer;">
        üîç DEBUG FORMATTING ISSUES
    </button>
    
    <div id="debug-results"></div>

    <script type="module">
        window.runCriticalDebug = async function() {
            const results = document.getElementById('debug-results');
            let output = '<div class="critical-banner">INVESTIGATING CRITICAL FORMATTING FAILURES</div>';
            
            try {
                // Test Case: User's problematic response
                const problematicResponse = `**Image Analysis - Baltimore Oriole**

This appears to be a Baltimore Oriole (Icterus galbula), a medium-sized songbird.

**Key identifying features:**
‚Ä¢ Bright orange plumage on head, breast, and belly  
‚Ä¢ Black head, wings, and back
‚Ä¢ White wing bars
‚Ä¢ Orange-yellow tail feathers

**Behavioral notes:**
‚Ä¢ Often found in deciduous trees
‚Ä¢ Feeds on insects, nectar, and fruit
‚Ä¢ Known for distinctive whistle-like calls

The bird appears to be perched on what looks like a branch or feeder, displaying the characteristic coloring that makes Baltimore Orioles easily identifiable.`;

                output += '<div class="test-section">';
                output += '<h3>üîç Step 1: Library Availability Check</h3>';
                
                // Load the chat module first
                const { ChatModule } = await import('./modules/chat/chat.js');
                const chat = new ChatModule();
                
                // Force initialize to ensure dependencies are loaded
                await chat.init();
                
                // Check if libraries are actually loaded
                const markedAvailable = typeof window.marked !== 'undefined';
                const dompurifyAvailable = typeof window.DOMPurify !== 'undefined';
                
                if (markedAvailable && dompurifyAvailable) {
                    output += '<div class="success">‚úÖ Libraries loaded: marked & DOMPurify available</div>';
                } else {
                    output += '<div class="error">‚ùå Libraries NOT loaded:</div>';
                    output += `<div class="error">   - marked: ${markedAvailable}</div>`;
                    output += `<div class="error">   - DOMPurify: ${dompurifyAvailable}</div>`;
                }
                
                output += '</div>';
                
                // Test Case 1: Direct markdown processing
                output += '<div class="test-section">';
                output += '<h3>üß™ Step 2: Direct Markdown Processing Test</h3>';
                
                let directHtml = '';
                if (window.marked) {
                    directHtml = window.marked.parse(problematicResponse);
                    if (window.DOMPurify) {
                        directHtml = window.DOMPurify.sanitize(directHtml);
                    }
                    output += '<div class="success">‚úÖ Direct markdown processing successful</div>';
                } else {
                    directHtml = 'ERROR: window.marked not available';
                    output += '<div class="error">‚ùå Direct markdown processing FAILED - marked not available</div>';
                }
                
                output += '<div class="before-after">';
                output += '<div class="before"><strong>Raw Input:</strong><br>';
                output += `<pre style="font-size: 12px;">${problematicResponse.substring(0, 200)}...</pre></div>';
                output += '<div class="after"><strong>Processed HTML:</strong><br>';
                output += `<div style="font-size: 12px; word-break: break-all;">${directHtml.substring(0, 300)}...</div></div>';
                output += '</div>';
                
                output += '</div>';
                
                // Test Case 2: Chat addMessage processing
                output += '<div class="test-section">';
                output += '<h3>üîÑ Step 3: Chat addMessage Processing Test</h3>';
                
                // Create mock chat window
                const mockChatWindow = document.createElement('div');
                mockChatWindow.className = 'mock-chat';
                const originalChatWindow = chat.chatWindow;
                chat.chatWindow = mockChatWindow;
                
                // Test addMessage with HTML processing
                chat.addMessage('bot', problematicResponse, false); // Let it auto-detect markdown
                
                const chatOutput = mockChatWindow.innerHTML;
                const hasBoldTags = chatOutput.includes('<strong>') || chatOutput.includes('<b>');
                const hasBulletPoints = chatOutput.includes('<ul>') && chatOutput.includes('<li>');
                const hasAsterisks = chatOutput.includes('**');
                
                output += '<div class="info">Chat Processing Results:</div>';
                if (hasBoldTags) {
                    output += '<div class="success">‚úÖ Bold formatting detected (HTML tags present)</div>';
                } else {
                    output += '<div class="error">‚ùå Bold formatting MISSING (no HTML tags)</div>';
                }
                
                if (hasBulletPoints) {
                    output += '<div class="success">‚úÖ Bullet points detected (HTML lists present)</div>';
                } else {
                    output += '<div class="error">‚ùå Bullet points MISSING (no HTML lists)</div>';
                }
                
                if (hasAsterisks) {
                    output += '<div class="error">‚ùå Raw asterisks still present - markdown not processed!</div>';
                } else {
                    output += '<div class="success">‚úÖ No raw asterisks - markdown processed</div>';
                }
                
                output += '<div class="test-result">';
                output += '<strong>Actual Chat Output:</strong><br>';
                output += chatOutput;
                output += '</div>';
                
                chat.chatWindow = originalChatWindow;
                output += '</div>';
                
                // Test Case 3: AI Response Simulation
                output += '<div class="test-section">';
                output += '<h3>ü§ñ Step 4: AI Response Processing Simulation</h3>';
                
                // Create another mock window
                const mockChatWindow2 = document.createElement('div');
                mockChatWindow2.className = 'mock-chat';
                chat.chatWindow = mockChatWindow2;
                
                // Simulate the exact AI response processing path
                let thinkingIndicator = chat.addMessage('bot', '...', false);
                thinkingIndicator.classList.add('thinking');
                
                // Simulate the response processing
                const processedReply = chat.processImageThumbnails(problematicResponse);
                
                let finalHtml = '';
                if (window.marked && window.DOMPurify) {
                    const html = window.marked.parse(processedReply);
                    const safeHtml = window.DOMPurify.sanitize(html);
                    thinkingIndicator.innerHTML = safeHtml;
                    finalHtml = safeHtml;
                    output += '<div class="success">‚úÖ AI response path: Used marked.parse() + DOMPurify</div>';
                } else {
                    thinkingIndicator.innerHTML = processedReply;
                    finalHtml = processedReply;
                    output += '<div class="error">‚ùå AI response path: Fell back to raw text (NO MARKDOWN PROCESSING)</div>';
                }
                thinkingIndicator.classList.remove('thinking');
                
                const aiHasBold = finalHtml.includes('<strong>') || finalHtml.includes('<b>');
                const aiHasBullets = finalHtml.includes('<ul>') && finalHtml.includes('<li>');
                const aiHasAsterisks = finalHtml.includes('**');
                
                output += '<div class="info">AI Response Processing Results:</div>';
                if (aiHasBold) {
                    output += '<div class="success">‚úÖ Bold formatting in AI response</div>';
                } else {
                    output += '<div class="error">‚ùå NO bold formatting in AI response</div>';
                }
                
                if (aiHasBullets) {
                    output += '<div class="success">‚úÖ Bullet points in AI response</div>';
                } else {
                    output += '<div class="error">‚ùå NO bullet points in AI response</div>';
                }
                
                if (aiHasAsterisks) {
                    output += '<div class="error">üö® CRITICAL: Raw asterisks in AI response - FORMATTING BROKEN</div>';
                } else {
                    output += '<div class="success">‚úÖ No raw asterisks in AI response</div>';
                }
                
                output += '<div class="test-result">';
                output += '<strong>AI Response Final Output:</strong><br>';
                output += mockChatWindow2.innerHTML;
                output += '</div>';
                
                chat.chatWindow = originalChatWindow;
                output += '</div>';
                
                // EXECUTIVE SUMMARY
                output += '<div class="test-section" style="border: 3px solid #f44336;">';
                output += '<h3>üìã EXECUTIVE SUMMARY - CRITICAL FINDINGS</h3>';
                
                const librariesOk = markedAvailable && dompurifyAvailable;
                const formattingWorking = !aiHasAsterisks && aiHasBold && aiHasBullets;
                
                if (formattingWorking) {
                    output += '<div class="success">‚úÖ FORMATTING IS WORKING CORRECTLY</div>';
                    output += '<ul>';
                    output += '<li>‚úÖ Libraries loaded properly</li>';
                    output += '<li>‚úÖ Bold text processing functional</li>';
                    output += '<li>‚úÖ Bullet points rendering correctly</li>';
                    output += '<li>‚úÖ No raw markdown visible</li>';
                    output += '</ul>';
                } else {
                    output += '<div class="error">üö® FORMATTING IS BROKEN - CONFIRMED</div>';
                    output += '<ul>';
                    if (!librariesOk) output += '<li>‚ùå Libraries not loading properly</li>';
                    if (aiHasAsterisks) output += '<li>‚ùå Raw asterisks visible - markdown not processed</li>';
                    if (!aiHasBold) output += '<li>‚ùå Bold text not rendering</li>';
                    if (!aiHasBullets) output += '<li>‚ùå Bullet points not rendering</li>';
                    output += '</ul>';
                    
                    output += '<div class="error"><strong>ROOT CAUSE:</strong> ';
                    if (!librariesOk) {
                        output += 'Markdown libraries (marked.js/DOMPurify) not loading properly in chat module</div>';
                    } else if (aiHasAsterisks) {
                        output += 'Libraries loaded but AI response processing path bypassing markdown conversion</div>';
                    } else {
                        output += 'Unknown - requires further investigation</div>';
                    }
                }
                
                output += '<div class="info"><strong>NEXT STEPS:</strong></div>';
                if (!formattingWorking) {
                    output += '<ol>';
                    output += '<li>Fix library loading or processing path</li>';
                    output += '<li>Add proper CSS for formatted content</li>';
                    output += '<li>Test with real AI responses</li>';
                    output += '<li>Get executive approval before marking complete</li>';
                    output += '</ol>';
                } else {
                    output += '<div class="success">Ready for executive review and approval</div>';
                }
                
                output += '</div>';
                
            } catch (error) {
                output += '<div class="error">‚ùå Critical debug failed: ' + error.message + '</div>';
                console.error('Critical debug error:', error);
            }
            
            results.innerHTML = output;
        };
    </script>
</body>
</html>